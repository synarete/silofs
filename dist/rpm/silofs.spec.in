Name: silofs
Summary:        The Silo File-System
Version:        @VERSION@
Release:        @RELEASE@.@REVISION@%{?dist}
License:        GPLv3
Group:          Applications/Archiving
URL:            https://synarete.github.io/silofs
Source:         %{name}-%{version}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}.%{_arch}
Requires:       libcap
Requires:       libuuid
Requires:       libgcrypt
Requires:       libunwind
%if 0%{?fedora} >= 36
BuildRequires:  libcap-devel
BuildRequires:  libuuid-devel
BuildRequires:  libgcrypt-devel
BuildRequires:  libunwind-devel
%endif

%{?systemd_requires}

%description
Silofs is a user-space file-system designed for storing large volumes
of data over encrypted blobs. It let normal users create an isolated
storage area, with its own private key, and mount it on a local host
machine. Once mounted, users may manipulate their data as they would
normally do with any other POSIX file-system, plus take full volume
snapshots, while the actual data and meta-data is securely stored
within local repository. The repository itself uses regular files as
encrypted blobs, which are opaque to any user other the file-system's
owner.

%package devel
Summary: Silofs testing utilities and development files
Group: Development/Tools
Requires: %{name}%{?_isa} = %{version}-%{release}
Requires: python3

%description devel
Various testing programs for silofs.

%prep
%setup -q -n %{name}-%{version}

%build
%configure
%{__make}

%check
# %{__make} check

%install
%make_install

%clean
%{__rm} -rf %{buildroot}

%files
%defattr(-, root, root)
%{_bindir}/%{name}
%{_sbindir}/%{name}-mountd
%{_sbindir}/*.%{name}
%exclude %{_libdir}/lib%{name}*.so.*
%exclude %{_libdir}/lib%{name}_*.*a
%config(noreplace) %{_sysconfdir}/%{name}/*.conf
%{_mandir}/man1/%{name}.1*
%{_mandir}/man8/%{name}-*.8*
%{_datarootdir}/bash-completion/completions/%{name}
%{_docdir}/%{name}/*
%if 0%{?_unitdir:1}
%dir %{_localstatedir}/%{_rundir}/%{name}
%{_unitdir}/%{name}-mountd.service
%else
%exclude %{_prefix}/lib/systemd/system/%{name}*.*
%endif

%files devel
%defattr(-, root, root)
%{_bindir}/%{name}-unitests
%{_bindir}/%{name}-vfstests
%{_bindir}/%{name}-citests
%{_prefix}/lib/python3*/site-packages/%{name}/*
%exclude %{_includedir}/*
%exclude %{_libdir}/lib%{name}*.so


%post
%systemd_post %{name}-mountd.service

%preun
%systemd_preun %{name}-mountd.service

%postun
%systemd_postun_with_restart %{name}-mountd.service

%changelog
* @RPMDATE@ Silofs <synarete@xxxxxxxx> @VERSION@-@RELEASE@.@REVISION@
- Release @REVISION@


